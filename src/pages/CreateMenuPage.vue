<template>
  <q-page class="column q-pa-lg form-page">
    <GalleryImg :image-data="dish.imageData" />

    <q-input
      rounded
      outlined
      v-model="dish.title"
      label="Название блюда"
      input-class="text-h6"
    />

    <q-input
      rounded
      outlined
      v-model="dish.description"
      label="Опишите как готовить блюдо"
      type="textarea"
      autogrow
    />

    <q-separator inset />

    <div class="column items-center group-set">
      <div class="text-subtitle1 text-grey-6">
        Установите температуру приготовления
      </div>
      <q-knob
        :step="1"
        v-model="dish.cooking_temperature"
        show-value
        size="120px"
        :max="300"
        :thickness="0.22"
        color="deep-orange"
        track-color="deep-orange-3"
        class="text-orange"
      />
    </div>

    <q-separator inset />

    <div class="column group-set">
      <q-toggle
        size="48px"
        v-model="dish.auto_heating"
        label="Установить температуру подогрева?"
      />

      <div v-if="dish.auto_heating" class="column items-center">
        <q-knob
          :step="1"
          v-model="dish.auto_heating_temp"
          show-value
          size="120px"
          :max="70"
          :thickness="0.22"
          color="orange"
          track-color="orange-3"
          class="text-orange"
        />
      </div>
    </div>

    <q-separator inset />

    <div class="column items-center group-set">
      <div class="column items-center">
        <div class="text-grey-6">Общее время приготовления</div>
        <AppTimer v-model="dish.total_time" style="font-size: 16px" />
      </div>
      <div class="column items-center">
        <div class="text-grey-6 text-center">
          Время приготовления<br />от достижения заданной температуры
        </div>
        <AppTimer v-model="cooking.cooking_time" style="font-size: 16px" />
      </div>
    </div>

    <q-separator inset />

    <q-card-actions
      class="q-px-none"
      align="center"
      vertical
      style="row-gap: 20px"
    >
      <q-btn
        v-if="dish.total_time === 0"
        padding="10px 16px"
        icon="play_arrow"
        class="glossy"
        rounded
        color="deep-orange"
        label="Начать приготовление"
        @click="startCooking"
      />
      <q-btn
        v-if="cooking.cooking_time > 0"
        padding="10px 16px"
        icon="stop_circle"
        class="glossy"
        rounded
        color="green"
        label="Нажми, если блюдо готово"
        @click="stopCooking"
      />
      <q-btn
        icon="delete_forever"
        flat
        label="Удалить"
        color="deep-orange"
        @click="onDeleteClick"
      />
      <!--      <q-btn label="Сохранить" color="primary" text-color="white" icon="save" />-->
    </q-card-actions>
  </q-page>
</template>

<style scoped lang="scss"></style>

<script lang="ts">
import { defineComponent } from 'vue';
import GalleryImg from 'components/GalleryImg.vue';
import { useQuasar } from 'quasar';
import useS3 from 'src/composables/useS3';
import AppTimer from 'components/AppTimer.vue';
import { useDish } from 'stores/appStore';
import { storeToRefs } from 'pinia';

export default defineComponent({
  name: 'CreateMenuPage',
  components: { AppTimer, GalleryImg },
  setup() {
    const $q = useQuasar();
    const S3 = useS3();
    const dishStore = useDish();

    const { dish, cooking } = storeToRefs(dishStore);

    let timerHandle: NodeJS.Timer;

    function onDeleteClick() {
      $q.dialog({
        title: 'Подтвердите',
        message: 'Вы действительно хотите удалить новое блюдо?',
        cancel: true,
        persistent: true,
      }).onOk(() => {
        dish.value.imageData.images.forEach((image) => {
          S3.Delete(image.fileName, import.meta.env.VITE_S3_IMG_DIR);
        });

        dishStore.newDish();
        clearInterval(timerHandle);
      });
    }

    function startCooking() {
      dish.value.total_time = Math.trunc(new Date().getTime() / 1000);
      cooking.value.current_temperature = 20;

      timerHandle = setInterval(() => {
        cooking.value.current_temperature =
          cooking.value.current_temperature + 5;

        if (
          cooking.value.current_temperature >= dish.value.cooking_temperature &&
          cooking.value.cooking_time === 0
        ) {
          cooking.value.cooking_time = Math.trunc(new Date().getTime() / 1000);
          clearInterval(timerHandle);
        }
      }, 700);
    }

    function stopCooking() {
      $q.dialog({
        title: 'Подтвердите сохранение',
        message: 'Вы действительно завершить приготовление и сохранить блюдо?',
        cancel: true,
        persistent: true,
      }).onOk(async () => {
        dish.value.saved_cooking_time =
          Math.trunc(new Date().getTime() / 1000) - cooking.value.cooking_time;

        await dishStore.saveToDishList(dish.value);

        dishStore.newDish();
      });
    }

    return {
      onDeleteClick,
      dish,
      startCooking,
      cooking,
      stopCooking,
    };
  },
});
</script>
